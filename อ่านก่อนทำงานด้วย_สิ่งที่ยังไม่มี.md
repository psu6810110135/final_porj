# Thai Tour Booking - Codebase Gap Analysis

> วิเคราะห์จากโค้ดจริงในโฟลเดอร์ `project/backend` และ `project/frontend` เทียบกับเอกสาร flow ใน `system_based`
>
> วันที่วิเคราะห์: 2026-02-28

---

## 1) สรุปสถานะปัจจุบัน (มีอะไรแล้วบ้าง)

## 1.1 ฟีเจอร์ฝั่งลูกค้า (User)

**มีแล้ว (ใช้งานได้ระดับหนึ่ง):**

- สมัคร/ล็อกอินปกติ + Google OAuth
  - Backend: `auth/signin`, `auth/signup`, `auth/google`
  - Frontend: หน้า Login/Register/Google callback
- หน้ารวมทัวร์ + รายละเอียดทัวร์
  - มี filter บางส่วน (region/category/duration) และดูรายละเอียดทัวร์ได้
- ระบบจองทัวร์เบื้องต้น
  - สร้าง booking ได้
  - ผูกกับ `tour_schedules` และเช็กที่นั่งคงเหลือ
  - มี cron หมดอายุ booking ที่ยังไม่จ่าย (`pending_pay -> expired`)
- หน้า Payment แสดง QR พร้อมยอดเงิน
- หน้า Booking History (แสดงรายการจอง)
- หน้า Profile (UI มีแล้ว)

## 1.2 ฟีเจอร์ฝั่งแอดมิน (Admin)

**มีแล้ว (โครงสร้างพร้อม):**

- Admin dashboard (แสดงสถิติรวม)
- จัดการทัวร์ (CRUD)
- จัดการตารางทัวร์ (Tour schedules)
- หน้าตรวจสอบการชำระเงิน (Pending payments)
- หน้า booking history ฝั่งแอดมิน
- หน้า user manager (มี UI แล้ว)

## 1.3 Backend Architecture

**มีแล้ว:**

- โมดูลหลักครบ: `auth`, `tours`, `bookings`, `payments`, `users`, `admin`
- ใช้ TypeORM + PostgreSQL + UUID entities
- มี DTO + validation บางส่วน
- มี transaction และ pessimistic locking ใน booking create
- มี schedule job สำหรับ expire booking

---

## 2) Gap สำคัญ (สิ่งที่ยังขาด/ยังไม่สมบูรณ์)

## 2.1 Payment Flow ยังไม่ครบธุรกิจจริง (Critical)

### สิ่งที่ขาด

1. **ไม่มี API อัปโหลดสลิปจริง**
   - เอกสาร flow คาดหวัง `POST /api/v1/payments/:bookingId/upload`
   - โค้ดปัจจุบันมีแค่ QR, pending list, verify, status
2. **ไม่มีการสร้าง/บันทึก Payment จากฝั่งลูกค้า**
   - จึงไม่มีจุดที่เปลี่ยน booking จาก `pending_pay -> pending_verify` ตอนลูกค้าอัปโหลดสลิป
3. **ไม่มี duplicate slip protection**
   - ไม่มี `slip_hash`, ไม่มี SHA-256 check
4. **ไม่มี reject reason ที่เก็บจริงใน DB**
   - Frontend ส่ง `rejectReason` แต่ backend ไม่ใช้และ entity ไม่มี field
5. **ไม่มีสิทธิ์ป้องกัน endpoint payment/admin ที่ชัดเจน**
   - endpoint สำคัญบางส่วนยังไม่ติด JWT/Role guard
6. **ข้อมูล frontend/backend ไม่ตรงกันหลายจุด**
   - `PendingPayments.tsx` ใช้ `slipUrl`, `createdAt` แต่ entity ใช้ `slip_url`, `uploadedAt`

### ต้องทำอะไรบ้าง (ละเอียด)

- เพิ่ม endpoint อัปโหลดสลิป:
  - `POST /api/v1/payments/:bookingId/upload` (JWT required)
  - ใช้ Multer + file size limit + MIME whitelist
  - เก็บไฟล์เป็น UUID filename
- เพิ่ม schema payment:
  - `slip_hash`, `reject_reason`, `verified_by`, `admin_notes` (ถ้าต้องใช้)
- เขียน service flow:
  - upload slip -> hash -> duplicate check -> create/update payment -> booking status = `pending_verify`
- ปรับ verify API:
  - รับ `{ status, rejectReason }`
  - ถ้า approve -> booking `confirmed`
  - ถ้า reject -> booking `pending_pay` + บันทึกเหตุผล
- ปรับหน้า PaymentPage:
  - เพิ่ม UI อัปโหลดสลิป + สถานะอัปโหลด
  - polling จาก endpoint payment status ที่ถูกต้อง

---

## 2.2 รีวิว/เรตติ้ง ยังไม่เป็นระบบจริง (Critical ตามโจทย์)

### สิ่งที่ขาด

- ไม่มีโมดูล `reviews` ใน backend
- ไม่มีตาราง/Entity รีวิวจริง
- ไม่มี API รีวิว (POST/GET)
- ไม่มีหน้าเขียนรีวิวและแสดงรีวิว
- `rating` และ `review_count` ใน `tours` ถูกกรอก manual จาก admin เท่านั้น

### ต้องทำอะไรบ้าง

- เพิ่ม backend module `reviews`
  - Entity: `Review { user_id, tour_id, booking_id, rating, comment }`
  - Constraint: 1 booking เขียนได้ 1 รีวิว
  - Endpoint:
    - `POST /api/v1/reviews` (customer, หลัง trip จบ + booking confirmed)
    - `GET /api/v1/tours/:id/reviews`
- เพิ่ม logic aggregate rating
  - เมื่อเพิ่ม/แก้/ลบ review ให้คำนวณ `tour.rating` และ `tour.review_count` อัตโนมัติ
- เพิ่ม frontend:
  - ส่วนแสดงรีวิวใน TourDetail
  - หน้า/โมดอล “เขียนรีวิว” จาก booking history (เฉพาะ booking ที่ eligible)

---

## 2.3 User Flow ยังขาดหลาย step สำคัญ

### เทียบกับ User Flow document แล้วขาด

1. **My Booking action ยังไม่ครบ**
   - ไม่มีปุ่มยกเลิก booking จากหน้า user
   - ไม่มีหน้า booking detail แยกรายการ
   - ไม่มี E-ticket view/download
   - ไม่มีทางอัปโหลดสลิปจากหน้า booking โดยตรง
2. **Profile API ไม่ตรงกัน**
   - Frontend เรียก `/api/v1/users/me` แต่ backend ไม่มี endpoint นี้
3. **Search filter บางตัวไม่ทำงานจริงที่ backend**
   - Frontend ส่ง `location`, `keyword` แต่ backend tours filter ใช้ `search/province/...`
4. **Payment หน้า user เป็น QR + polling เท่านั้น**
   - ยังไม่ครอบคลุม flow upload/รอตรวจ/ปฏิเสธพร้อมเหตุผล

### ต้องทำอะไรบ้าง

- เพิ่มหน้า/route:
  - `BookingDetailPage` (รายละเอียด booking + actions ตาม status)
  - `ETicketPage` หรือ download endpoint
  - `ReviewPage/Modal`
- เพิ่ม action ใน BookingHistoryPage:
  - Cancel booking (call `PATCH /api/v1/bookings/:id/cancel`)
  - Upload slip / View reject reason / Retry payment
- เพิ่ม endpoint `GET /api/v1/users/me`
- ปรับ search contract ให้ตรงกันทั้ง FE/BE

---

## 2.4 Admin Flow ยังขาด governance และความครบถ้วน

### เทียบกับ Admin Flow document แล้วขาด

1. **Backend admin endpoints ส่วนหนึ่งไม่มี guard จริง**
   - `admin`, `payments`, `tours`, `users` หลาย route เข้าถึงได้โดยไม่ยืนยัน role
2. **User management เป็น UI มากกว่าฟีเจอร์จริง**
   - FE เรียก `/api/v1/users` แต่ BE ใช้ `/users` (route mismatch)
   - service บางตัวเป็น stub (`create/remove` ยังไม่ทำงานจริง)
3. **ไม่มีหน้า Reports ตาม flow**
4. **Payment verify ยังไม่เห็นข้อมูลครบ**
   - สลิปอาจไม่แสดงเพราะ field mismatch
   - reject reason ไม่ persist

### ต้องทำอะไรบ้าง

- บังคับใช้ AuthGuard + RolesGuard กับทุก route admin-sensitive
- แยก admin API ชัดเจน:
  - `/api/v1/admin/users` สำหรับ admin เท่านั้น
  - ย้าย logic จัดการผู้ใช้เข้า admin service
- เพิ่มหน้า `AdminReportsPage` + API สรุปรายได้/ยอดจองตามช่วงเวลา
- ปรับ pending payments UI/DTO ให้ตรง entity จริง

---

## 3) หน้าเพจที่ยังไม่มี (Missing Pages)

## ฝั่ง User (ควรมี)

1. **Booking Detail Page** (แยกจาก list)
2. **Upload Payment Slip Page/Section** (หรืออยู่ใน PaymentPage แต่ต้องมี upload)
3. **E-Ticket Page** (ดู/ดาวน์โหลด)
4. **Write Review Page/Modal**
5. **Review List section** ในหน้า TourDetail
6. **Custom Error pages** (เช่น 404/403 แบบเป็นทางการ)

## ฝั่ง Admin (ควรมี)

1. **Reports Page** (ตาม flow dashboard -> reports)
2. **Payment Detail View** แบบเต็ม (slip + reject history + admin notes)
3. **User Detail/Edit Role/Block Page** (ถ้าต้องการ admin governance)

---

## 4) User Flow Gap Check (Step-by-step)

## 4.1 Registration/Login

- ✅ มี signup/signin/google
- ⚠️ ยังไม่มี forgot/reset password flow (ถ้าต้องการ production)

## 4.2 Browse/Search Tours

- ✅ ดู list/detail ได้
- ⚠️ query บางตัวไม่แมปกับ backend ทำให้ผลค้นหาไม่แม่น

## 4.3 Booking

- ✅ สร้าง booking + เช็ก schedule/capacity
- ⚠️ ยังไม่รองรับ journey หลังจากจองแบบครบวงจร (detail/cancel/rebook ที่ชัด)

## 4.4 Payment

- ✅ มี QR แสดงยอด
- ❌ ไม่มี upload slip, duplicate check, reject reason, retry flow ที่ครบ

## 4.5 My Bookings

- ✅ มี list + สถานะ
- ❌ ขาด booking detail/cancel/e-ticket/review actions

---

## 5) Admin Flow Gap Check (Step-by-step)

## 5.1 Admin Login

- ✅ มี AdminGuard ฝั่ง frontend
- ⚠️ backend หลาย route ยังไม่ enforce role guard จริง

## 5.2 Manage Tours

- ✅ CRUD tours + schedules
- ⚠️ ยังไม่มี soft-delete policy/ audit trail

## 5.3 Verify Payments

- ✅ มีหน้า pending + approve/reject
- ❌ ข้อมูลสลิป/เหตุผลปฏิเสธไม่ครบ และต้นทาง upload ยังไม่สมบูรณ์

## 5.4 Dashboard/Reports

- ✅ มี dashboard stats เบื้องต้น
- ❌ ไม่มี reports page + analytics จริงตาม flow

---

## 6) Technical/Architecture Improvements ที่ควรทำ

## 6.1 API Contract Consistency

- รวม prefix ให้ชัดเจน: ใช้ `api/v1` ให้ตรงทั้งระบบ (ยกเว้น auth ตามที่ตั้งใจ)
- แก้ FE/BE route mismatch:
  - `/api/v1/users` vs `/users`
  - `/api/v1/users/me` (ควรมีจริง)
- ใช้ response format เดียวกันทั้งระบบ (เช่น `{ success, data, message }`)

## 6.2 Security & Access Control

- ใส่ `@UseGuards(AuthGuard('jwt'), RolesGuard)` ใน route admin/tours/payments/users ที่ต้องป้องกัน
- ย้าย JWT secret ไป env (เลิก hardcode)
- เพิ่ม validation สำหรับ payment verify payload และ file upload

## 6.3 Data Integrity

- ใช้ enum/status กลางสำหรับ payment + booking
- เพิ่ม index/constraint สำหรับ payment duplication และ review uniqueness
- เพิ่ม transaction ในจุด verify payment + update booking

## 6.4 Frontend Maintainability

- สร้าง API client กลาง (axios instance + base URL + auth interceptor)
- ลด hardcoded `http://localhost:3000`
- ย้าย type กลางสำหรับ Booking/Payment/User เพื่อไม่ให้แต่ละหน้า shape ไม่ตรงกัน

---

## 7) Roadmap แนะนำเพื่อให้ “สมบูรณ์”

## Phase A (เร่งด่วน - ต้องทำก่อน)

1. ปิด gap payment flow ทั้งหมด (upload/verify/reject reason/status)
2. บังคับ auth+role guard ใน endpoint สำคัญ
3. แก้ route mismatch FE/BE ให้ทุกหน้าใช้งานได้จริง

## Phase B (สำคัญมาก)

1. เพิ่ม Reviews module + UI
2. เพิ่ม booking detail + cancel + e-ticket flow
3. เพิ่ม users/me และ profile update flow

## Phase C (เสริมความสมบูรณ์)

1. เพิ่ม admin reports page + export
2. ปรับโครง response/API client ให้คงที่
3. เพิ่ม test ครอบคลุมกรณี payment/review/admin guard

---

## 8) Executive Summary (สั้น)

โปรเจกต์นี้มีแกนหลักใช้งานได้แล้ว (Auth, Tours, Booking, Admin UI) แต่ยัง **ไม่สมบูรณ์ใน 3 แกนหลัก** คือ:

1. **Payment production flow ยังไม่ครบ** (ขาด upload slip + verify lifecycle เต็ม)
2. **Reviews ยังไม่ถูก implement จริง**
3. **Admin governance และ route consistency ยังมีช่องโหว่**

ถ้าปิด 3 จุดนี้ได้ ระบบจะใกล้ “เว็บจองทัวร์ที่ใช้งานจริงครบวงจร” มากที่สุดในระยะสั้น
